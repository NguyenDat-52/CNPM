CREATE DATABASE QL_KHACHSAN;
GO
USE QL_KHACHSAN;
GO

CREATE TABLE TAI_KHOAN (
    MA_TK INT IDENTITY PRIMARY KEY,
    TEN_DANG_NHAP NVARCHAR(50) UNIQUE NOT NULL,
    MAT_KHAU NVARCHAR(200) NOT NULL,
    VAI_TRO NVARCHAR(20) NOT NULL 
);
GO
-- BẢNG KHÁCH HÀNG
CREATE TABLE KHACH_HANG (
    MA_KH INT IDENTITY PRIMARY KEY,
    HO_TEN NVARCHAR(100) NOT NULL,
    SDT VARCHAR(15),
    EMAIL NVARCHAR(100),
    CCCD VARCHAR(20),
    MA_TK INT UNIQUE,
    FOREIGN KEY (MA_TK) REFERENCES TAI_KHOAN(MA_TK)
);
GO

-- BẢNG NHÂN VIÊN
CREATE TABLE NHAN_VIEN (
    MA_NV INT IDENTITY PRIMARY KEY,
    HO_TEN NVARCHAR(100),
    CHUC_VU NVARCHAR(50),
    SDT VARCHAR(15),
    MA_TK INT UNIQUE,
    FOREIGN KEY (MA_TK) REFERENCES TAI_KHOAN(MA_TK)
);
GO

-- BẢNG LOẠI PHÒNG
CREATE TABLE LOAI_PHONG (
    MA_LOAI INT IDENTITY PRIMARY KEY,
    TEN_LOAI NVARCHAR(50),
    MO_TA NVARCHAR(255),
    GIA_MOT_DEM DECIMAL(18,2)
);
GO

-- BẢNG PHÒNG
CREATE TABLE PHONG (
    MA_PHONG INT IDENTITY PRIMARY KEY,
    TEN_PHONG NVARCHAR(50),
    TANG INT,
    TRANG_THAI NVARCHAR(20), 
    MA_LOAI INT,
    FOREIGN KEY (MA_LOAI) REFERENCES LOAI_PHONG(MA_LOAI)
);
GO

-- BẢNG DỊCH VỤ
CREATE TABLE DICH_VU (
    MA_DV INT IDENTITY PRIMARY KEY,
    TEN_DV NVARCHAR(100),
    GIA_DV DECIMAL(18,2)
);
GO

-- BẢNG ĐẶT PHÒNG
CREATE TABLE DAT_PHONG (
    MA_DP INT IDENTITY PRIMARY KEY,
    MA_KH INT,
    MA_PHONG INT,
    NGAY_DAT DATE,
    NGAY_NHAN DATE,
    NGAY_TRA DATE,
    TIEN_COC DECIMAL(18,2),
    TRANG_THAI NVARCHAR(20),
    FOREIGN KEY (MA_KH) REFERENCES KHACH_HANG(MA_KH),
    FOREIGN KEY (MA_PHONG) REFERENCES PHONG(MA_PHONG)
);
GO

-- BẢNG DỊCH VỤ SỬ DỤNG TRONG THỜI GIAN LƯU TRÚ
CREATE TABLE SU_DUNG_DV (
    MA_SD INT IDENTITY PRIMARY KEY,
    MA_DP INT,
    MA_DV INT,
    SO_LUONG INT,
    NGAY_SU_DUNG DATE,
    FOREIGN KEY (MA_DP) REFERENCES DAT_PHONG(MA_DP),
    FOREIGN KEY (MA_DV) REFERENCES DICH_VU(MA_DV)
);
GO

-- BẢNG HÓA ĐƠN TỔNG
CREATE TABLE HOA_DON (
    MA_HD INT IDENTITY PRIMARY KEY,
    MA_DP INT,
    TONG_TIEN DECIMAL(18,2),
    NGAY_XUAT DATE,
    DA_THANH_TOAN BIT,
    FOREIGN KEY (MA_DP) REFERENCES DAT_PHONG(MA_DP)
);
GO

-- BẢNG HÓA ĐƠN TẠM THỜI (KHI ĐẶT CỌC)
CREATE TABLE HOA_DON_TAM (
    MA_HDT INT IDENTITY PRIMARY KEY,
    MA_DP INT,
    TIEN_COC DECIMAL(18,2),
    NGAY_XUAT DATE,
    FOREIGN KEY (MA_DP) REFERENCES DAT_PHONG(MA_DP)
);
GO

-- BẢNG ĐÁNH GIÁ KHÁCH HÀNG
CREATE TABLE DANH_GIA (
    MA_DG INT IDENTITY PRIMARY KEY,
    MA_KH INT,
    MA_PHONG INT,
    NOI_DUNG NVARCHAR(255),
    SO_SAO INT,
    NGAY_DANHGIA DATE,
    FOREIGN KEY (MA_KH) REFERENCES KHACH_HANG(MA_KH),
    FOREIGN KEY (MA_PHONG) REFERENCES PHONG(MA_PHONG)
);
GO
CREATE TABLE ALBUM_ANH_PHONG (
    MA_ANH INT IDENTITY PRIMARY KEY,
    MA_PHONG INT,
    LINK_ANH NVARCHAR(255),
    FOREIGN KEY (MA_PHONG) REFERENCES PHONG(MA_PHONG)
);
GO

-- DỮ LIỆU
-- 1. Dữ liệu cho LOẠI_PHONG
INSERT INTO LOAI_PHONG (TEN_LOAI, MO_TA, GIA_MOT_DEM)
VALUES 
('PHÒNG ĐƠN', '1 GIƯỜNG', 500000),
('PHÒNG ĐÔI', '2 GIƯỜNG', 800000),
('PHÒNG VIP', '1 GIƯỜNG KING SIZE, BAN CÔNG', 1500000);
GO
-- 2. Dữ liệu cho PHÒNG
INSERT INTO PHONG (TEN_PHONG, TANG, TRANG_THAI, MA_LOAI)
VALUES 
('P101', 1, 'TRỐNG', 1),
('P102', 1, 'TRỐNG', 2),
('P103', 1, 'TRỐNG', 1),
('P201', 2, 'TRỐNG', 2),
('P202', 2, 'TRỐNG', 2),
('P203', 2, 'TRỐNG', 3),
('P301', 3, 'TRỐNG', 1),
('P302', 3, 'TRỐNG', 3),
('P303', 3, 'TRỐNG', 2),
('P304', 3, 'TRỐNG', 3);
GO
-- 3. Dữ liệu cho DICH_VU
INSERT INTO DICH_VU (TEN_DV, GIA_DV)
VALUES 
('GIẶT ỦI', 50000),
('ĂN UỐNG', 120000),
('SPA', 300000),
('HỘP QUÀ', 200000);
GO

-- 4. Dữ liệu cho TAI_KHOAN
INSERT INTO TAI_KHOAN (TEN_DANG_NHAP, MAT_KHAU, VAI_TRO)
VALUES 
('ADMIN', '123456', 'QUANTRI'),
('LETAN01', '123456', 'NHANVIEN'),
('KHACH01', '123456', 'KHACHHANG'),
('KHACH02', '123456', 'KHACHHANG'),
('KHACH03', '123456', 'KHACHHANG');
GO
-- 5. Dữ liệu cho KHACH_HANG
INSERT INTO KHACH_HANG (HO_TEN, SDT, EMAIL, CCCD, MA_TK)
VALUES 
(N'Nguyễn Văn Ánh', '090111222', 'Anhnguyen@gmail.com', '0123456789', 3),
(N'Lê Thị Bích', '090222333', 'Bichle@gmail.com', '0123456790', 4),
(N'Phạm Văn Cường', '090333444', 'Cuongpham@gmail.com', '0123456791', 5);
GO

-- 6. Dữ liệu cho NHAN_VIEN
INSERT INTO NHAN_VIEN (HO_TEN, CHUC_VU, SDT, MA_TK)
VALUES 
(N'Nguyễn Thị Anh Thư', 'LỄ TÂN', '090123456', 2);
GO

-- 7. Dữ liệu cho DAT_PHONG
INSERT INTO DAT_PHONG (MA_KH, MA_PHONG, NGAY_DAT, NGAY_NHAN, NGAY_TRA, TIEN_COC, TRANG_THAI)
VALUES 
(1, 1, '2025-11-01', '2025-11-10', '2025-11-12', 200000, 'DA_NHAN'),
(2, 2, '2025-11-02', '2025-11-15', '2025-11-18', 250000, 'DA_NHAN'),
(3, 3, '2025-11-03', '2025-11-20', '2025-11-22', 150000, 'DA_DAT');
GO

-- 8. Dữ liệu cho SU_DUNG_DV
INSERT INTO SU_DUNG_DV (MA_DP, MA_DV, SO_LUONG, NGAY_SU_DUNG)
VALUES 
(1, 1, 2, '2025-11-11'),
(1, 2, 1, '2025-11-11'),
(2, 2, 2, '2025-11-16'),
(2, 3, 1, '2025-11-17');
GO

-- 9. Dữ liệu cho HOA_DON_TAM
INSERT INTO HOA_DON_TAM (MA_DP, TIEN_COC, NGAY_XUAT)
VALUES 
(1, 200000, '2025-11-01'),
(2, 250000, '2025-11-02'),
(3, 150000, '2025-11-03');
GO

-- 10. Dữ liệu cho DANH_GIA
INSERT INTO DANH_GIA (MA_KH, MA_PHONG, NOI_DUNG, SO_SAO, NGAY_DANHGIA)
VALUES 
(1, 1, N'Phòng sạch, nhân viên thân thiện', 5, '2025-11-12'),
(2, 2, N'Phòng đẹp, view tốt', 4, '2025-11-18');
GO

-- 11. Dữ liệu cho ALBUM_ANH_PHONG (10 phòng)

INSERT INTO ALBUM_ANH_PHONG (MA_PHONG, LINK_ANH)
VALUES 
(1, 'https://images.unsplash.com/photo-1502672260266-1c1ef2d93688?auto=format&fit=crop&w=800'),
(1, 'https://images.unsplash.com/photo-1505691723518-36a5ac3be353?auto=format&fit=crop&w=800'),
(2, 'https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?auto=format&fit=crop&w=800'),
(2, 'https://images.unsplash.com/photo-1667125095636-dce94dcbdd96?q=80&w=852&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'),
(3, 'https://images.unsplash.com/photo-1554995207-c18c203602cb?auto=format&fit=crop&w=800'),
(3, 'https://plus.unsplash.com/premium_photo-1661962493427-910e3333cf5a?q=80&w=880&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'),
(4, 'https://images.unsplash.com/photo-1600585154340-be6161a56a0c?auto=format&fit=crop&w=800'),
(4, 'https://images.unsplash.com/photo-1611892440504-42a792e24d32?auto=format&fit=crop&w=800'),
(5, 'https://images.unsplash.com/photo-1559841644-08984562005a?q=80&w=1074&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'),
(5, 'https://images.unsplash.com/photo-1587985064135-0366536eab42?q=80&w=1170&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'),
(6, 'https://images.unsplash.com/photo-1595576508898-0ad5c879a061?q=80&w=1074&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'),
(6, 'https://plus.unsplash.com/premium_photo-1674676471380-1258cb31b3ac?q=80&w=1109&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'),
(7, 'https://images.unsplash.com/photo-1605346434674-a440ca4dc4c0?q=80&w=987&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'),
(7, 'https://images.unsplash.com/photo-1609766857041-ed402ea8069a?q=80&w=1170&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'),
(8, 'https://plus.unsplash.com/premium_photo-1661962340349-6ea59fff7e7b?q=80&w=1074&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'),
(8, 'https://images.unsplash.com/photo-1631049035182-249067d7618e?q=80&w=1170&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'),
(9, 'https://images.unsplash.com/photo-1590490359854-dfba19688d70?q=80&w=1074&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'),
(9, 'https://images.unsplash.com/photo-1595161695996-f746349f4945?q=80&w=1014&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'),
(10, 'https://plus.unsplash.com/premium_photo-1684445035187-c4bc7c96bc5d?q=80&w=687&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'),
(10, 'https://plus.unsplash.com/premium_photo-1661886031345-d14bf4e09a07?q=80&w=1074&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D');

GO
-- PHÂN QUYỀN CHO CÁC LOẠI TÀI KHOẢN
CREATE ROLE QUAN_TRI;
CREATE ROLE LE_TAN;
CREATE ROLE KHACH_HANG;
-- GÁN QUYỀN
GRANT SELECT, INSERT, UPDATE, DELETE ON PHONG TO QUAN_TRI;
GRANT SELECT, INSERT, UPDATE, DELETE ON LOAI_PHONG TO QUAN_TRI;
GRANT SELECT, INSERT, UPDATE, DELETE ON DICH_VU TO QUAN_TRI;
GRANT SELECT, INSERT, UPDATE, DELETE ON KHACH_HANG TO QUAN_TRI;
GRANT SELECT, INSERT, UPDATE, DELETE ON NHAN_VIEN TO QUAN_TRI;
GO
GRANT SELECT, INSERT, UPDATE ON DAT_PHONG TO LE_TAN;
GRANT SELECT ON KHACH_HANG TO LE_TAN;
GRANT SELECT ON PHONG TO LE_TAN;
GO
GRANT SELECT ON PHONG TO KHACH_HANG;
GRANT SELECT, INSERT ON DAT_PHONG TO KHACH_HANG;
GO

-- VIEW 
CREATE VIEW VW_DOANH_THU_NGAY AS
SELECT 
    HD.NGAY_XUAT,
    SUM(HD.TONG_TIEN) AS DOANH_THU
FROM HOA_DON HD
GROUP BY HD.NGAY_XUAT;
GO

-- PROCEDURE TÍNH TIỀN HÓA ĐƠN
-- TÍNH: TIỀN PHÒNG + TIỀN DỊCH VỤ

CREATE PROCEDURE SP_TINH_HOA_DON
    @MA_DP INT
AS
BEGIN
    DECLARE @TIEN_PHONG DECIMAL(18,2),
            @SO_DEM INT,
            @TONG_DV DECIMAL(18,2);

    -- TÍNH SỐ NGÀY Ở
    SELECT @SO_DEM = DATEDIFF(DAY, NGAY_NHAN, NGAY_TRA)
    FROM DAT_PHONG WHERE MA_DP = @MA_DP;

    -- TIỀN PHÒNG
    SELECT @TIEN_PHONG = @SO_DEM * LP.GIA_MOT_DEM
    FROM DAT_PHONG DP
    JOIN PHONG P ON DP.MA_PHONG = P.MA_PHONG
    JOIN LOAI_PHONG LP ON P.MA_LOAI = LP.MA_LOAI
    WHERE DP.MA_DP = @MA_DP;

    -- TIỀN DỊCH VỤ
    SELECT @TONG_DV = ISNULL(SUM(SDDV.SO_LUONG * DV.GIA_DV),0)
    FROM SU_DUNG_DV SDDV
    JOIN DICH_VU DV ON SDDV.MA_DV = DV.MA_DV
    WHERE MA_DP = @MA_DP;

    -- XUẤT HÓA ĐƠN
    INSERT INTO HOA_DON (MA_DP, TONG_TIEN, NGAY_XUAT, DA_THANH_TOAN)
    VALUES (@MA_DP, @TIEN_PHONG + @TONG_DV, GETDATE(), 0);
END;
GO
-- PROCEDURE
CREATE PROCEDURE SP_SU_DUNG_DICH_VU
    @MA_DP INT,
    @MA_DV INT,
    @SO_LUONG INT
AS
BEGIN
    INSERT INTO SU_DUNG_DV (MA_DP, MA_DV, SO_LUONG, NGAY_SU_DUNG)
    VALUES (@MA_DP, @MA_DV, @SO_LUONG, GETDATE());
END;
GO

-- TRIGGER: KHI GHI NHẬN ĐẶT PHÒNG → ĐỔI TRẠNG THÁI PHÒNG = 'DA_DAT'
CREATE TRIGGER TG_DATPHONG_TRANGTHAI
ON DAT_PHONG
AFTER INSERT
AS
BEGIN
    UPDATE PHONG 
    SET TRANG_THAI = 'DA_DAT'
    WHERE MA_PHONG IN (SELECT MA_PHONG FROM INSERTED);
END;
GO

-- TRIGGER: KHI CHECK-IN → TRẠNG THÁI = 'CO_KHACH'
CREATE TRIGGER TG_CHECKIN_TRANGTHAI
ON DAT_PHONG
AFTER UPDATE
AS
BEGIN
    IF UPDATE(TRANG_THAI)
    BEGIN
        UPDATE PHONG
        SET TRANG_THAI = 'CO_KHACH'
        WHERE MA_PHONG IN (
            SELECT MA_PHONG FROM INSERTED WHERE TRANG_THAI = 'DA_NHAN'
        );
    END
END;
GO

-- TRIGGER: KHI CHECK-OUT → TRẠNG THÁI PHÒNG = 'TRỐNG'
CREATE TRIGGER TG_CHECKOUT_TRANGTHAI
ON DAT_PHONG
AFTER UPDATE
AS
BEGIN
    IF UPDATE(TRANG_THAI)
    BEGIN
        UPDATE PHONG
        SET TRANG_THAI = 'TRỐNG'
        WHERE MA_PHONG IN (
            SELECT MA_PHONG FROM INSERTED WHERE TRANG_THAI = 'HOAN_THANH'
        );
    END
END;
GO

-- TRIGGER: KHI KHÁCH ĐẶT PHÒNG → TẠO HÓA ĐƠN TẠM (30% TIỀN CỌC)
CREATE TRIGGER TG_HOADON_TAM
ON DAT_PHONG
AFTER INSERT
AS
BEGIN
    INSERT INTO HOA_DON_TAM (MA_DP, TIEN_COC, NGAY_XUAT)
    SELECT MA_DP, TIEN_COC, GETDATE()
    FROM INSERTED;
END;
GO
